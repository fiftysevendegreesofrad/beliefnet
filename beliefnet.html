<!DOCTYPE>

<html>

	<head>
		<title>BeliefNet</title>

		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	  
		<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

		<!--polyfills are needed for this extension for old browsers like IE -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.5.7/shim.min.js"></script>

		<script src="https://unpkg.com/layout-base/layout-base.js"></script>
		<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
		<script src="https://unpkg.com/cytoscape-avsdf/cytoscape-avsdf.js"></script>

		<script src="gamedata.js"></script>
		<script src="BeliefGraphUtils.js"></script>


		<link rel="stylesheet" href="style.css">

		<script>
			let DEVMODE = true;
			let nodeDisplay = DEVMODE?"element":"none";

			let narrative = [];
			
			function updateBelievabilityDisplay(cy)
			{
				let believability = computeBelievabilityFromLogLik(updateLogLik(cy));
				console.log(believability);
				document.getElementById("loglik").innerHTML = believability;
				cy.resize();
			}
			function updateNarrativeDisplay()
			{
				html = "";
				for (let i=0;i<narrative.length;i++)
				{
					let message = narrative[i].message;
					let undo = narrative[i].undo;
					html += "<div class='line'><button onclick='revert("+undo+")'>Undo</button>"+message+"</div>";
				}
				document.getElementById("narrative").innerHTML = html;
			}
			function updateGraphDisplay(cy)
			{
				let visibleNodes = cy.nodes(":visible");
				let layoutOptions = {
						name: 'avsdf',
						nodeSeparation: 120,
						animate: "end",
						animationDuration: 1000,
						animationEasing: 'ease-in-out',
						nodeSeparation: 120,
						eles:visibleNodes
					};
				cy.layout(layoutOptions).run();
			}
			document.addEventListener('DOMContentLoaded', async function(){

				let elements = await load_elements();
				
				var cy = window.cy = cytoscape({
					container: document.getElementById('cy'),

					style: [
						{
							selector: 'node',
							style: {
								'label': 'data(displaylabel)',
								'text-valign': 'center',
								'color': '#000000',
								'pie-1-background-color':'mapData(predicateValue, 0, 1, blue, purple)',
								'pie-1-background-size':'mapData(baseProb,0,1,0,100)',
								'pie-2-background-color':'mapData(predicateValue, 0, 1, #aaaaff, #ffaaff)',
								'pie-2-background-size':'mapData(baseProb,0,1,100,0)',
								'display':nodeDisplay
							}
						},
						{
							selector: 'node[predicateValue=0.5]',
							style: {
								'pie-1-background-color':'#444444',
								'pie-2-background-color':'#aaaaaa',
							}
						},
						
						{
							selector: 'edge',
							style: {
								'width': 'mapData(absweight, 0, 5, 0, 7)',
								'line-color': 'data(color)',
								'opacity': 0.5,
								'target-arrow-shape': 'triangle',
								'target-arrow-color': 'data(color)',
								'source-arrow-shape': 'triangle',
								'source-arrow-color': 'data(color)',
								'curve-style': 'unbundled-bezier',
								'control-point-distances': '10px -10px',
								'control-point-weights': '0.25 0.75'
							}
						}
					],

					elements: elements,
					autounselectify: true,
					autoungrabify: true,
					userZoomingEnabled: false,
					userPanningEnabled: false
				});
				let firstNode = cy.nodes().first();
				firstNode.style("display","element");
				refreshNodeDetails(firstNode);
				updateGraphDisplay(cy);
				updateLogLik(cy); //call to initialize node logprobs
				updateBelievabilityDisplay(cy);

				cy.bind('click', 'node', function(evt) {
					let node = evt.target;
					displayNodeDetails(node);
				});

				function refreshNodeDetails(node)
				{
					var leftPanel = document.getElementsByClassName("left-panel")[0];
					leftPanel.classList.remove("show");
					setTimeout(function() {displayNodeDetails(node);}, 350);
				}
				function displayNodeDetails(node)
				{
					var leftPanel = document.getElementsByClassName("left-panel")[0];
					leftPanel.classList.add("show");
					document.getElementById("topic").innerHTML=node.data("displaylabel");
					let options = node.data().options;
					let whichSelected = predicateToIndex(node);
					let predicateValue = node.data("predicateValue");
					let color = predicateValue==0.5?"#111111":(predicateValue>0.5?"purple":"blue");
					document.getElementById("currentBelief").innerHTML="<font color="+color+"><b>"+options[whichSelected]+"</b></font>";

					//create research button
					document.getElementById("ResearchButton").innerHTML="";
					if (!node.data("researched"))
					{
						let button = document.createElement("button");
						button.innerHTML = "Research Related Beliefs";
						button.addEventListener("click", function(evt1){
							node.data("researched",true);
							//iterate through neighbouring nodes
							for (n of node.openNeighborhood("node"))
								n.style("display","element");
							refreshNodeDetails(node);
							updateGraphDisplay(cy);
						});
						document.getElementById("ResearchButton").appendChild(button);
					}
					else
					{
						let supportingBeliefs = [];
						let opposingBeliefs = [];
						let neutralBeliefs = [];
						for (n of node.openNeighborhood("node"))
						{
							let mutualSupport = computeNodeMutualSupport(node,n);
							let otherBelief = n.data().displaylabel+": "+n.data().options[predicateToIndex(n)];
							if (mutualSupport>0)
								supportingBeliefs.push([mutualSupport,otherBelief]);
							else if (mutualSupport<0)
								opposingBeliefs.push([mutualSupport,otherBelief]);
							else
								neutralBeliefs.push([mutualSupport,otherBelief]);
						}
						if (supportingBeliefs.length>0)
						{
							document.getElementById("ResearchButton").innerHTML+="<h3>Currently Supporting:</h3>";
							let list = document.createElement("ul");
							for (let [mutualSupport,otherBelief] of supportingBeliefs)
							{
								list.innerHTML += "<li><font color=green>+"+mutualSupport+": "+otherBelief+"</font></li>";
							}
							document.getElementById("ResearchButton").appendChild(list);
						}
						if (opposingBeliefs.length>0)
						{
							document.getElementById("ResearchButton").innerHTML+="<h3>Currently Opposing:</h3>";
							let list = document.createElement("ul");
							for (let [mutualSupport,otherBelief] of opposingBeliefs)
							{
								list.innerHTML += "<li><font color=red>"+mutualSupport+": "+otherBelief+"</font></li>";
							}
							document.getElementById("ResearchButton").appendChild(list);
						}
						if (neutralBeliefs.length>0)
						{
							document.getElementById("ResearchButton").innerHTML+="<h3>Currently Neutral:</h3>";
							let list = document.createElement("ul");
							for (let [mutualSupport,otherBelief] of neutralBeliefs)
							{
								list.innerHTML += "<li>"+otherBelief+"</li>";
							}
							document.getElementById("ResearchButton").appendChild(list);
						}
					}
					//create buttons for other options
					document.getElementById("nodeDetails").innerHTML="";
					let prevNodeValues = cy.elements().map(x=>x.json()); //for undo not yet implemented
					let table = document.createElement("table");
					for (let i=0; i<options.length; i++)
					{
						if (i==whichSelected) continue;

						let row = document.createElement("tr");

						let optionSpan = document.createElement("span");
						optionSpan.innerHTML = options[i];

						let button = document.createElement("button");
						let buttonPredValue = getPredicateFromIndex(node.data(), i);
						button.innerHTML = "Influence";

						console.log("Computing believability for "+options[i]);
						let resultingBelievability = computeBelievabilityFromLogLik(altNetworkLogLik(cy,{[node.id()]:buttonPredValue}));
						let minBelievability = computeBelievabilityFromLogLik(PERMITTEDMINLOGPROB);
						
						let possible = resultingBelievability>minBelievability;
						
						if (possible)
						{
							if (DEVMODE)
									button.style.backgroundColor = "green";
							button.addEventListener("click", function(evt1){
								node.data("predicateValue",buttonPredValue); 
								narrative.push({message:options[i], undo:prevNodeValues});
								updateBelievabilityDisplay(cy);
								updateNarrativeDisplay();
								refreshNodeDetails(node);
							});
						}
						else
						{
							if (DEVMODE)
									button.style.backgroundColor = "red";
							button.addEventListener("click", function(evt1){
								//make modal popup
								let modal = document.getElementById("myModal");
								let span = document.getElementsByClassName("close")[0];
								modal.style.display = "block";
								span.onclick = function() {
									modal.style.display = "none";
								}
								window.onclick = function(event) {
									if (event.target == modal) {
										modal.style.display = "none";
									}
								}
								
							});
						}

						let td = document.createElement("td");
						td.appendChild(button);
						row.appendChild(td);
						let td2 = document.createElement("td");
						td2.appendChild(optionSpan);
						row.appendChild(td2);
						table.appendChild(row);
					}
					document.getElementById("nodeDetails").appendChild(table);
				}
				


			});
		</script>
	</head>

	<body>
		<div class="header">
			<h1>Narrative Believability: <span id="loglik"/></h1>
		</div>
		
		<!-- Panels -->
		<div class="row">
		<div class="col-sm-3 left-panel">
			<h1 id="topic"></h1>
			<h2>Subject's Current Belief:</h2>
			<ul>
			<li id="currentBelief"></li>
			</ul>
			<h2>Alternative Beliefs:</h2>
			<p id="nodeDetails"></p>
			<h2>Subject's Related Beliefs:</h2>
			<div id="ResearchButton"></div>
		</div>
		<div class="col-sm-6">
			<div id="cy"></div>
		</div>
		<div class="col-sm-3 right-panel">
			<h1>Narrative</h1>
			<div id="narrative"></div>
		</div>
		</div>
		
		<div id="myModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<p>You efforts to influence this belief are not successful. They don't buy it. </p>
				<p>You will need to build a narrative that starts with something more believable.
				</p>
			</div>
		</div>
		
		
	</body>

</html>
