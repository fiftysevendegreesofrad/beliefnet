<!DOCTYPE>

<html>

<head>
	<title>BeliefNet</title>

	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

	<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

	<!--polyfills are needed for this extension for old browsers like IE -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.5.7/shim.min.js"></script>

	<script src="https://unpkg.com/layout-base/layout-base.js"></script>
	<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
	<script src="https://unpkg.com/cytoscape-avsdf/cytoscape-avsdf.js"></script>

	<script src="gamedata.js"></script>
	<script src="BeliefGraphUtils.js"></script>
	<script src="BeliefPanel.js"></script>


	<link rel="stylesheet" href="style.css">

	<script>
		let DEVMODE;
		let ALLOWIMPOSSIBLEMOVES;
		if (window.location.protocol === 'file:') {
			DEVMODE = false;
			ALLOWIMPOSSIBLEMOVES = true;
		} else {
			DEVMODE = false; //DO NOT CHANGE
			ALLOWIMPOSSIBLEMOVES = false; //DO NOT CHANGE
		}
		let nodeDisplay = DEVMODE ? "element" : "none";

		//get clown images clown1.jpg through to clown7.jpg in an array
		const NUMCLOWNIMAGES = 7;
		let clownImages = [];
		for (let i = 1; i <= NUMCLOWNIMAGES; i++)
		{
			let img = new Image();
			img.src = "img/clown" + i + ".jpg";
			clownImages.push(img);
		}

		function updateClownImage(cy)
		{
			//print all predicate values to console
			let predicates = cy.nodes().map(x => x.data().predicateValue);
			let totalPredicateValue = cy.nodes().map(x => x.data().predicateValue).reduce((a, b) => a + b);
			let proportionComplete = totalPredicateValue/cy.nodes().size();
			//madness is proportionComplete scaled such that MADNESS_THRESHOLD becomes 0 but 1 is still 1
			const MADNESS_THRESHOLD = 0.1;
			let madness = Math.max(0,proportionComplete-MADNESS_THRESHOLD)/(1-MADNESS_THRESHOLD);
			let clownImageIndex = Math.floor(madness*(NUMCLOWNIMAGES-1));
			let img = clownImages[clownImageIndex];
			let madpercent = Math.floor(madness*100);
			img.alt = `Picture of ${CHARACTERNAME} looking ${madpercent}% mad`;
			document.getElementById("clown-image-container").innerHTML = "";
			document.getElementById("clown-image-container").appendChild(img);
		}

		let narrative = [];
		function updateProgressBar(percentage) {
			let progressBar = document.getElementById("progress-bar");
			progressBar.style.width = percentage + "%";
		}
		function updateBelievabilityDisplay(cy) {
			let logLik = updateLogLik(cy);
			let believability = computeBelievabilityFromLogLik(logLik);
			let bullshit = 100 - believability;
			document.getElementById("moving-text").textContent = bullshit.toFixed(1) + "%";
			updateProgressBar(bullshit);
			if (DEVMODE)
				document.getElementById("moving-text").textContent += " " + logLik.toFixed(2);
			cy.resize();
		}
		function showModal(message) {			
			let modal = document.getElementById("myModal");
			let span = document.getElementsByClassName("close")[0];
			modal.style.display = "block";
			span.onclick = function () {
				modal.style.display = "none";
			}
			window.onclick = function (event) {
				if (event.target == modal) {
					modal.style.display = "none";
				}
			}
			document.getElementsByClassName("modal-message")[0].innerHTML = message;
		}
		function stringListToTableRow(list) {
			let row = document.createElement("tr");

			for (let i = 0; i < list.length; i++) {
				let cell = document.createElement("td");
				cell.innerHTML = list[i];
				row.appendChild(cell);
			}
			return row;
		}
		function updateNarrativeDisplay() {
			let table = document.createElement("table");

			for (let i = 0; i < narrative.length; i++) {
				let message = narrative[i].message;
				let undo = narrative[i].undo;
				let logLik = narrative[i].logLik;
				let prevLogLik = narrative[i].prevLogLik;
				let llDiff = (logLik - prevLogLik).toFixed(2);
				if (llDiff >= 0)
					llDiff = "+" + llDiff;

				let row = stringListToTableRow(["<button onclick='revert(" + undo + ")'>Undo</button>",
				logLik.toFixed(2), "(" + llDiff + ")", message]);

				table.appendChild(row);
			}
			document.getElementById("narrative").innerHTML = "";
			document.getElementById("narrative").appendChild(table);
		}
		function updateGraphDisplay(cy) {
			let visibleNodes = cy.nodes(":visible");
			let layoutOptions = {
				name: 'avsdf',
				nodeSeparation: 120,
				animate: "end",
				animationDuration: 1000,
				animationEasing: 'ease-in-out',
				nodeSeparation: 120,
				eles: visibleNodes
			};
			cy.layout(layoutOptions).run();
		}
		document.addEventListener('DOMContentLoaded', async function () {
			document.querySelectorAll('.CharacterName').forEach(function(element) {
				element.textContent = CHARACTERNAME;
			});

			let elements = await load_elements();
			let maxweight = elements.edges.map(x => x.data.absweight).reduce((a, b) => Math.max(a, b));

			var cy = window.cy = cytoscape({
				container: document.getElementById('cy'),

				style: [
					{
						selector: 'node',
						style: {
							'label': 'data(displaylabel)',
							'text-valign': 'center',
							'color': '#000000',
							'width': 'mapData(logprob,-3,0,60,20)',
							'height': 'mapData(logprob,-3,0,60,20)',
							'pie-1-background-color': 'mapData(predicateValue, 0, 1, blue, purple)',
							'pie-1-background-size': 'mapData(baseProb,0,1,0,100)',
							'pie-2-background-color': 'mapData(predicateValue, 0, 1, #aaaaff, #ffaaff)',
							'pie-2-background-size': 'mapData(baseProb,0,1,100,0)',
							'display': nodeDisplay
						}
					},
					{
						selector: 'node[predicateValue=0.5]',
						style: {
							'pie-1-background-color': '#444444',
							'pie-2-background-color': '#aaaaaa',
						}
					},
					{
						selector: 'node[researched=0]',
						style: {
							'border-width': '10px',
							'border-color': '#aaaaaa',
							'border-style': 'dotted'
						}
					},
					{
						selector: 'node[researched=1]',
						style: {
							'border-width': '0px',
						}
					},
					{
						selector: 'edge',
						style: {
							'width': 'mapData(absweight, 0, ' + maxweight + ', 0, 7)',
							'line-color': 'data(color)',
							'opacity': 0.5,
							'target-arrow-shape': 'triangle',
							'target-arrow-color': 'data(color)',
							//'source-arrow-shape': 'triangle',
							//'source-arrow-color': 'data(color)',
							'curve-style': 'unbundled-bezier',
							'control-point-distances': '10px',
							'control-point-weights': '0.5',
							'label': 'data(weight)'
						}
					}
				],

				elements: elements,
				autounselectify: true,
				autoungrabify: true,
				userZoomingEnabled: false,
				userPanningEnabled: false
			});
			let firstNode = cy.nodes().first();
			firstNode.style("display", "element");
			refreshNodeDetails(firstNode);
			updateGraphDisplay(cy);
			updateLogLik(cy); //call to initialize node logprobs
			updateBelievabilityDisplay(cy);

			cy.bind('click', 'node', function (evt) {
				let node = evt.target;
				displayNodeDetails(node);
			});

			



		});
	</script>
</head>

<body>
	<div class="header">
		<span id="fixed-text"><span class="CharacterName"></span>'S<br>BULLSHITOMETER</span>
		<div id="progress-bar-container">
			<div id="progress-bar">
				<span id="moving-text"></span>
			</div>
		</div>
	</div>

	<!-- Panels -->
	<div class="row">
		<div class="col-sm-4 left-panel">
			<div class="image-text-container">
				<div class="bordered-image" id="clown-image-container"></div>
				<p class="image-text"><b><u>PsyOps Target Subject</u></b>
					<br>Name: <span class="CharacterName"></span>
					<br>Age: 28
					<br>Relationship status: Single
					<br>Occupation: Telemarketer (Unemployed)
					<br>Health status: Moderate
					<br>
					<br><b><u>PsyOps Target Belief</u></b>
					<br>Reptilian Elite
				</p>
			</div>
			<h1 id="topic"></h1>
			<p id="currentBelief"></p>
			<h2>Alternative Beliefs:</h2>
			<p id="nodeDetails"></p>

			<div id="ResearchButton"></div>
		</div>
		<div class="col-sm-8">
			<div id="cy"></div>
		</div>
		<div class="col-sm-3 right-panel">
			<h1>Narrative</h1>
			<div id="narrative"></div>
		</div>
	</div>

	<div id="myModal" class="modal">
		<div class="modal-content"><span class='close'>&times;</span><span class="modal-message"></span>
		</div>
	</div>


</body>

</html>