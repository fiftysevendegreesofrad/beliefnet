<!DOCTYPE>

<html>

<head>
	<title>BeliefNet</title>

	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

	<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

	<!--polyfills are needed for this extension for old browsers like IE -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.5.7/shim.min.js"></script>

	<script src="https://unpkg.com/layout-base/layout-base.js"></script>
	<script src="https://unpkg.com/avsdf-base/avsdf-base.js"></script>
	<script src="https://unpkg.com/cytoscape-avsdf/cytoscape-avsdf.js"></script>

	<script src="gamedata.js"></script>
	<script src="BeliefGraphUtils.js"></script>


	<link rel="stylesheet" href="style.css">

	<script>
		const DEVMODE = false;
		const ALLOWIMPOSSIBLEMOVES = false;
		let nodeDisplay = DEVMODE ? "element" : "none";

		let narrative = [];
		function updateProgressBar(percentage) {
			let progressBar = document.getElementById("progress-bar");
			progressBar.style.width = percentage + "%";
		}
		function updateBelievabilityDisplay(cy) {
			let logLik = updateLogLik(cy);
			let believability = computeBelievabilityFromLogLik(logLik);
			let bullshit = 100 - believability;
			document.getElementById("moving-text").textContent = bullshit.toFixed(1) + "%";
			updateProgressBar(bullshit);
			if (DEVMODE)
				document.getElementById("moving-text").textContent += " " + logLik.toFixed(2);
			cy.resize();
		}
		function showModal(message) {			
			let modal = document.getElementById("myModal");
			let span = document.getElementsByClassName("close")[0];
			modal.style.display = "block";
			span.onclick = function () {
				modal.style.display = "none";
			}
			window.onclick = function (event) {
				if (event.target == modal) {
					modal.style.display = "none";
				}
			}
			document.getElementsByClassName("modal-message")[0].innerHTML = message;
		}
		function stringListToTableRow(list) {
			let row = document.createElement("tr");

			for (let i = 0; i < list.length; i++) {
				let cell = document.createElement("td");
				cell.innerHTML = list[i];
				row.appendChild(cell);
			}
			return row;
		}
		function updateNarrativeDisplay() {
			let table = document.createElement("table");

			for (let i = 0; i < narrative.length; i++) {
				let message = narrative[i].message;
				let undo = narrative[i].undo;
				let logLik = narrative[i].logLik;
				let prevLogLik = narrative[i].prevLogLik;
				let llDiff = (logLik - prevLogLik).toFixed(2);
				if (llDiff >= 0)
					llDiff = "+" + llDiff;

				let row = stringListToTableRow(["<button onclick='revert(" + undo + ")'>Undo</button>",
				logLik.toFixed(2), "(" + llDiff + ")", message]);

				table.appendChild(row);
			}
			document.getElementById("narrative").innerHTML = "";
			document.getElementById("narrative").appendChild(table);
		}
		function updateGraphDisplay(cy) {
			let visibleNodes = cy.nodes(":visible");
			let layoutOptions = {
				name: 'avsdf',
				nodeSeparation: 120,
				animate: "end",
				animationDuration: 1000,
				animationEasing: 'ease-in-out',
				nodeSeparation: 120,
				eles: visibleNodes
			};
			cy.layout(layoutOptions).run();
		}
		document.addEventListener('DOMContentLoaded', async function () {
			document.querySelectorAll('.CharacterName').forEach(function(element) {
				element.textContent = CHARACTERNAME;
			});

			let elements = await load_elements();
			let maxweight = elements.edges.map(x => x.data.absweight).reduce((a, b) => Math.max(a, b));

			var cy = window.cy = cytoscape({
				container: document.getElementById('cy'),

				style: [
					{
						selector: 'node',
						style: {
							'label': 'data(displaylabel)',
							'text-valign': 'center',
							'color': '#000000',
							'width': 'mapData(logprob,-3,0,60,20)',
							'height': 'mapData(logprob,-3,0,60,20)',
							'pie-1-background-color': 'mapData(predicateValue, 0, 1, blue, purple)',
							'pie-1-background-size': 'mapData(baseProb,0,1,0,100)',
							'pie-2-background-color': 'mapData(predicateValue, 0, 1, #aaaaff, #ffaaff)',
							'pie-2-background-size': 'mapData(baseProb,0,1,100,0)',
							'display': nodeDisplay
						}
					},
					{
						selector: 'node[predicateValue=0.5]',
						style: {
							'pie-1-background-color': '#444444',
							'pie-2-background-color': '#aaaaaa',
						}
					},
					{
						selector: 'node[researched=0]',
						style: {
							'border-width': '10px',
							'border-color': '#aaaaaa',
							'border-style': 'dotted'
						}
					},
					{
						selector: 'node[researched=1]',
						style: {
							'border-width': '0px',
						}
					},
					{
						selector: 'edge',
						style: {
							'width': 'mapData(absweight, 0, ' + maxweight + ', 0, 7)',
							'line-color': 'data(color)',
							'opacity': 0.5,
							'target-arrow-shape': 'triangle',
							'target-arrow-color': 'data(color)',
							//'source-arrow-shape': 'triangle',
							//'source-arrow-color': 'data(color)',
							'curve-style': 'unbundled-bezier',
							'control-point-distances': '10px',
							'control-point-weights': '0.5',
							'label': 'data(weight)'
						}
					}
				],

				elements: elements,
				autounselectify: true,
				autoungrabify: true,
				userZoomingEnabled: false,
				userPanningEnabled: false
			});
			let firstNode = cy.nodes().first();
			firstNode.style("display", "element");
			refreshNodeDetails(firstNode);
			updateGraphDisplay(cy);
			updateLogLik(cy); //call to initialize node logprobs
			updateBelievabilityDisplay(cy);

			cy.bind('click', 'node', function (evt) {
				let node = evt.target;
				displayNodeDetails(node);
			});

			function refreshNodeDetails(node) {
				var leftPanel = document.getElementsByClassName("left-panel")[0];
				leftPanel.classList.remove("show");
				setTimeout(function () { displayNodeDetails(node); }, 350);
			}
			function predicateToTextColour(predicateValue) {
				return predicateValue == 0.5 ? "#111111" : (predicateValue > 0.5 ? "purple" : "blue");
			}
			function displayNodeDetails(node) {
				var leftPanel = document.getElementsByClassName("left-panel")[0];
				leftPanel.classList.add("show");
				document.getElementById("topic").innerHTML = node.data("displaylabel");
				let options = node.data().options;
				let whichSelected = predicateToIndex(node);
				let predicateValue = node.data("predicateValue");
				let color = predicateToTextColour(predicateValue);
				document.getElementById("currentBelief").innerHTML = "<font color=" + color + "><b>"+CHARACTERNAME+" currently believes: " + options[whichSelected] + "</b></font>";

				//create research button
				document.getElementById("ResearchButton").innerHTML = "";
				if (node.data("researched")==0) {
					let button = document.createElement("button");
					button.innerHTML = "Research Influencing Beliefs";
					button.addEventListener("click", function (evt1) {
						node.data("researched", 1);
						//iterate through neighbouring nodes
						for (e of node.incomers())
							e.source().style("display", "element");
						refreshNodeDetails(node);
						updateGraphDisplay(cy);
					});
					document.getElementById("ResearchButton").appendChild(button);
				}
				else {
					let supportingBeliefs = [];
					let opposingBeliefs = [];
					let neutralBeliefs = [];
					for (let [e, nodeSupport] of getSupportingEdgesCoeffs(node)) {
						let n = e.source();
						let otherBelief = n.data().displaylabel + ": " + n.data().options[predicateToIndex(n)];
						const otherPredicate = n.data().predicateValue;

						let narrative = getNarrative(e,otherPredicate,predicateValue);
						if (narrative!="")
							narrative = " <i>" + narrative + "</i>";
						
						if (nodeSupport > 0)
							supportingBeliefs.push([nodeSupport, otherBelief, narrative]);
						else if (nodeSupport < 0)
							opposingBeliefs.push([nodeSupport, otherBelief, narrative]);
						else
							neutralBeliefs.push([nodeSupport, otherBelief, narrative]);
					}
					if (supportingBeliefs.length + opposingBeliefs.length + neutralBeliefs.length == 0) {
						document.getElementById("ResearchButton").innerHTML += "<h3>No influencing beliefs found</h3>"
													+"<p>This belief appears to stand alone.</p>"
					}
					else
						document.getElementById("ResearchButton").innerHTML += "<h3>"+CHARACTERNAME+"'s other beliefs...</h3>";
					if (supportingBeliefs.length > 0) {
						document.getElementById("ResearchButton").innerHTML += "<h3>...currently supporting this one:</h3>";
						let list = document.createElement("ul");
						for (let [mutualSupport, otherBelief, narrative] of supportingBeliefs) {
							list.innerHTML += "<li><font color=green>+" + mutualSupport + ": " + otherBelief + ".</font>"+narrative+"</li>";
						}
						document.getElementById("ResearchButton").appendChild(list);
					}
					if (opposingBeliefs.length > 0) {
						document.getElementById("ResearchButton").innerHTML += "<h3>...currently opposing this one:</h3>";
						let list = document.createElement("ul");
						for (let [mutualSupport, otherBelief, narrative] of opposingBeliefs) {
							list.innerHTML += "<li><font color=red>" + mutualSupport + ": " + otherBelief + ".</font>"+narrative+"</li>";
						}
						document.getElementById("ResearchButton").appendChild(list);
					}
					if (neutralBeliefs.length > 0) {
						document.getElementById("ResearchButton").innerHTML += "<h3>...that could affect this one, but currently don't:</h3>";
						let list = document.createElement("ul");
						for (let [mutualSupport, otherBelief, narrative] of neutralBeliefs) {
							list.innerHTML += "<li>" + otherBelief + ".</li>";
							assert(narrative=="");
						}
						document.getElementById("ResearchButton").appendChild(list);
					}
				}
				//create buttons for other options
				document.getElementById("nodeDetails").innerHTML = "";
				let prevNodeValues = cy.elements().map(x => x.json()); //for undo not yet implemented
				let table = document.createElement("table");
				for (let i = 0; i < options.length; i++) {
					let row = document.createElement("tr");
					row.classList.add("optiontable");


					let optionSpan = document.createElement("span");
					const isTargetOption = (node.data().target && i==0);
					let htmlOption = "";
					let color = predicateToTextColour(getPredicateFromIndex(node.data(), i));
					if (isTargetOption)
						htmlOption+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=darkbg><font class=target color=ffff00><b>&nbsp;&darr; GAME TARGET &darr;&nbsp;</b></font></span><br><font class=target>";
					htmlOption +=  "<font color="+color+">"+options[i]+"</font>";
					if (isTargetOption)
						htmlOption+='</font><br><i>(Your aim is to convince '+CHARACTERNAME+' of this)</i>';
					optionSpan.innerHTML = htmlOption;

					let button = document.createElement("button");
					if (i != whichSelected) {
						let buttonPredValue = getPredicateFromIndex(node.data(), i);
						button.innerHTML = "Influence";

						let currentLogLik = updateLogLik(cy);
						let resultingLogLik = altNetworkLogLik(cy, { [node.id()]: buttonPredValue });
						let resultingBelievability = computeBelievabilityFromLogLik(resultingLogLik);

						let possible = resultingLogLik >= PERMITTEDMINLOGPROB;

						if (DEVMODE && possible) {
								button.style.backgroundColor = "green";
								button.innerHTML = resultingLogLik.toFixed(2);
							}
						if (DEVMODE && !possible) {
							button.style.backgroundColor = "red";
							button.innerHTML = resultingLogLik.toFixed(2);
							if (ALLOWIMPOSSIBLEMOVES)
								possible = true;
						}
						if (possible) {

							button.addEventListener("click", function (evt1) {
								node.data("predicateValue", buttonPredValue);
								narrative.push({
									message: options[i],
									logLik: resultingLogLik, prevLogLik: currentLogLik, undo: prevNodeValues
								});
								updateBelievabilityDisplay(cy);
								updateNarrativeDisplay();
								refreshNodeDetails(node);
								if (isTargetOption)
									showModal("<h1>Well done!</h1><h2>Convinced that we are governed by reptiles, "+CHARACTERNAME+" goes out one day and stabs a zookeeper.</h2><h2>I hope you're proud of yourself.</h2>");
							});
						}
						else {
							button.addEventListener("click", function (evt1) {
								let message = `<h2>You can't convince ${CHARACTERNAME} of this. 
								           		His bullshitometer would climb above 100%.</h2>
										   		<h3>Hints</h3><ul>`;
								//if node is not researched, suggest researching it
								if (node.data("researched")==0)
									message += `<li>Try researching ${CHARACTERNAME}'s influencing beliefs first</li>`;
								else
								{
									message += `<li>Maybe influencing some other beliefs first will help.</li>`;
									message += `<li>If not, maybe something else you've done is driving ${CHARACTERNAME}'s bullshitometer too high to trust you.
										<br>
											Look at the mind map for clues:
											<ul>
												<li>Are any beliefs drawn larger? This means they are triggering the bullshitometer more.</li>
												<li>Are any links between beliefs drawn in red? This means they are currently contradicting each other.</li>
												<li>Are any links between beliefs drawn in grey? This means they aren't influencing each other at all right now, but they potentially could.</li>
											</ul>	
										</li>`;
								}
								showModal(message);
							});
						}
					}
					else {
						button.innerHTML = "<i>Current</i>";
						button.disabled = true;
					}

					let td = document.createElement("td");
					td.appendChild(button);
					row.appendChild(td);
					let td2 = document.createElement("td");
					td2.appendChild(optionSpan);
					row.appendChild(td2);
					table.appendChild(row);
				}
				document.getElementById("nodeDetails").appendChild(table);
			}



		});
	</script>
</head>

<body>
	<div class="header">
		<span id="fixed-text"><span class="CharacterName"></span>'S<br>BULLSHITOMETER</span>
		<div id="progress-bar-container">
			<div id="progress-bar">
				<span id="moving-text"></span>
			</div>
		</div>
	</div>

	<!-- Panels -->
	<div class="row">
		<div class="col-sm-3 left-panel">
			<h1 id="topic"></h1>
			<p id="currentBelief"></p>
			<h2>Alternative Beliefs:</h2>
			<p id="nodeDetails"></p>

			<div id="ResearchButton"></div>
		</div>
		<div class="col-sm-6">
			<div id="cy"></div>
		</div>
		<div class="col-sm-3 right-panel">
			<h1>Narrative</h1>
			<div id="narrative"></div>
		</div>
	</div>

	<div id="myModal" class="modal">
		<div class="modal-content"><span class='close'>&times;</span><span class="modal-message"></span>
		</div>
	</div>


</body>

</html>